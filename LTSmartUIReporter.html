<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <title>LambdaTest SmartUI Reporter</title>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #333333;
      --panel-color: #f9f9f9;
      --border-color: #dddddd;
      --accent-color: #007bff;
      --hover-color: #eaf3ff;
      --main-font: 'Public Sans', 'Manrope', 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      --body-font-size: 16px;
      --body-line-height: 24px;
      --body-font-weight: 400;
      --subtext-font-size: 14px;
      --subtext-line-height: 20px;
      --subtext-font-weight: 400;
      --button-font-size: 15px;
      --button-line-height: 20px;
      --button-font-weight: 500;
      --button-font-weight-bold: 600;
      --h1-font-size: 36px;
      --h1-line-height: 44px;
      --h1-font-weight: 700;
      --h2-font-size: 30px;
      --h2-line-height: 38px;
      --h2-font-weight: 700;
      --h2-font-weight-alt: 600;
      --h3-font-size: 24px;
      --h3-line-height: 32px;
      --h3-font-weight: 600;
      --h4-font-size: 20px;
      --h4-line-height: 28px;
      --h4-font-weight: 600;
    }

    .dark-mode {
      --bg-color: #1e1e1e;
      --text-color: #f5f5f5;
      --panel-color: #2e2e2e;
      --border-color: #444444;
      --accent-color: #66aaff;
      --hover-color: #2a2a2a;
    }

    html, body {
      font-family: var(--main-font) !important;
      font-size: var(--body-font-size);
      line-height: var(--body-line-height);
      font-weight: var(--body-font-weight);
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      width: 100vw;
      box-sizing: border-box;
      letter-spacing: 0.01em;
    }

    *, *::before, *::after {
      font-family: var(--main-font) !important;
      box-sizing: border-box;
    }

    main#mainContent, .controls, .summary-table, .image-row, .image-box, .label, .footer-left, .footer-right, .sticky-header, .settings-modal-content {
      font-family: var(--main-font) !important;
      letter-spacing: 0.01em;
    }

    body, main#mainContent {
      font-size: var(--body-font-size);
      line-height: var(--body-line-height);
      font-weight: var(--body-font-weight);
    }

    .subtext, .footer-left, .footer-right, .summary-table td.subtext, .summary-table th.subtext {
      font-size: var(--subtext-font-size);
      line-height: var(--subtext-line-height);
      font-weight: var(--subtext-font-weight);
      color: #888;
    }

    button, .button, .reset-icon-btn, .darkmode-icon-btn, .settings-icon-btn {
      font-size: var(--button-font-size) !important;
      line-height: var(--button-line-height) !important;
      font-weight: var(--button-font-weight) !important;
    }

    button.strong, .button.strong {
      font-weight: var(--button-font-weight-bold) !important;
    }

    h1, .h1 {
      font-size: var(--h1-font-size);
      line-height: var(--h1-line-height);
      font-weight: var(--h1-font-weight);
      margin: 0 0 0.5em 0;
      letter-spacing: -0.01em;
    }

    h2, .h2 {
      font-size: var(--h2-font-size);
      line-height: var(--h2-line-height);
      font-weight: var(--h2-font-weight);
      margin: 0 0 0.5em 0;
      letter-spacing: -0.01em;
    }

    h3, .h3 {
      font-size: var(--h3-font-size);
      line-height: var(--h3-line-height);
      font-weight: var(--h3-font-weight);
      margin: 0 0 0.5em 0;
      letter-spacing: -0.01em;
    }

    h4, .h4 {
      font-size: var(--h4-font-size);
      line-height: var(--h4-line-height);
      font-weight: var(--h4-font-weight);
      margin: 0 0 0.5em 0;
      letter-spacing: -0.01em;
    }

    .summary-table td, .summary-table th {
      padding-top: 18px;
      padding-bottom: 18px;
      letter-spacing: 0.01em;
    }

    .controls, .dashboard {
      margin-bottom: 8px;
    }

    main#mainContent {
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      width: 100vw;
      box-sizing: border-box;
      min-width: 0;
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 50px;
      margin-bottom: 48px;
    }

    .sticky-header {
      background: #f5f7fa;
      color: #444;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      z-index: 100;
      height: 50px;
      box-sizing: border-box;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode .sticky-header {
      background: #23272e;
      color: #e0e0e0;
    }

    .sticky-header h1 {
      font-size: 1.25rem;
      margin: 0;
    }

    select,
    button,
    input[type="file"] {
      margin-left: 5px;
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
    }

    .hidden {
      display: none;
    }

    .summary-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 24px 0 16px 0;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 24px #0001;
      background: var(--bg-color);
    }
    .summary-table th {
      cursor: pointer;
      background-color: var(--panel-color);
      padding: 14px 16px;
      text-align: left;
      font-weight: 700;
      border-bottom: 2px solid var(--border-color);
      color: #111;
      font-size: 1.08em;
    }
    .summary-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 1.01em;
      background: var(--bg-color);
      transition: background 0.18s;
    }
    .summary-table tr:nth-child(even) td {
      background-color: var(--panel-color);
    }
    .summary-table tr:hover td {
      background-color: var(--hover-color);
    }
    .summary-table a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 1px dotted var(--accent-color);
      transition: color 0.18s, border-bottom 0.18s;
    }
    .summary-table a:hover {
      text-decoration: underline;
      color: #0056b3;
      border-bottom: 2px solid var(--accent-color);
    }
    .summary-table thead th:first-child {
      border-top-left-radius: 14px;
    }
    .summary-table thead th:last-child {
      border-top-right-radius: 14px;
    }
    .summary-table tr:last-child td:first-child {
      border-bottom-left-radius: 14px;
    }
    .summary-table tr:last-child td:last-child {
      border-bottom-right-radius: 14px;
    }

    .controls,
    .dashboard {
      padding: 15px 20px;
      background: var(--panel-color);
      border-bottom: 1px solid var(--border-color);
    }

    .controls label {
      margin-right: 15px;
    }

    .viewport-content {
      margin: 20px;
    }

    .image-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .image-box {
      flex: 1;
      background: var(--bg-color);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
      transition: box-shadow 0.2s, border 0.2s;
    }

    .image-box:hover {
      box-shadow: 0 4px 24px rgba(0,0,0,0.12);
      border: 1.5px solid var(--accent-color);
    }

    .image-box img {
      width: 100%;
      border-radius: 4px;
    }

    .label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }

    .mismatch-low {
      color: green;
    }

    .mismatch-mid {
      color: orange;
    }

    .mismatch-high {
      color: red;
    }

    footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 24px;
      border-top: 1px solid var(--border-color);
      background-color: #f5f7fa;
      color: #444;
      font-size: 0.95em;
      flex-shrink: 0;
      width: 100vw;
      left: 0;
      box-sizing: border-box;
      z-index: 100;
      gap: 12px;
      flex-wrap: wrap;
      position: fixed;
      bottom: 0;
      height: 48px;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode footer {
      background-color: #23272e;
      color: #e0e0e0;
    }
    .footer-left {
      text-align: left;
      white-space: nowrap;
      flex: 1 1 auto;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .footer-right {
      text-align: right;
      white-space: nowrap;
      flex: 1 1 auto;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }
    .footer-right a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
      margin-left: 4px;
      word-break: break-all;
    }
    @media (max-width: 700px) {
      footer { flex-direction: column; align-items: flex-start; padding: 10px 8px; }
      .footer-left, .footer-right { text-align: left; justify-content: flex-start; }
      html, body {
        font-size: 13.6px;
        line-height: 20.4px;
      }
      h1, .h1 {
        font-size: 30.6px;
        line-height: 37.4px;
      }
      h2, .h2 {
        font-size: 25.5px;
        line-height: 32.3px;
      }
      h3, .h3 {
        font-size: 20.4px;
        line-height: 27.2px;
      }
      h4, .h4 {
        font-size: 17px;
        line-height: 23.8px;
      }
      .subtext, .footer-left, .footer-right, .summary-table td.subtext, .summary-table th.subtext {
        font-size: 11.9px;
        line-height: 17px;
      }
      button, .button, .reset-icon-btn, .darkmode-icon-btn, .settings-icon-btn {
        font-size: 12.75px !important;
        line-height: 17px !important;
      }
    }

    #buildInfo {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px 20px;
    }

    .image-slider-container {
      position: relative;
      width: 100%;
      height: auto;
      overflow: hidden;
      border-radius: 4px;
      user-select: none;
    }

    .image-slider-img {
      display: block;
      width: 100%;
      height: auto;
      border-radius: 4px;
      position: absolute;
      top: 0;
      left: 0;
    }

    .image-slider-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent-color);
      cursor: ew-resize;
      z-index: 2;
      border-radius: 2px;
      transition: background 0.2s;
    }

    .slider-container {
      position: relative;
      width: 100%;
      overflow: hidden;
      background: #000;
      cursor: ew-resize;
      border-radius: 10px;
      box-shadow: 0 2px 12px #0001;
    }
    .slider-container img.baseline-image {
      width: 100%;
      height: auto;
      display: block;
      position: relative;
      z-index: 1;
      border-radius: 10px;
    }
    .slider-container img.after-image {
      width: 100%;
      height: auto;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
      pointer-events: none;
      border-radius: 10px;
    }
    .slider-handle {
      position: absolute;
      top: 50%;
      left: 95%;
      width: 32px;
      height: 32px;
      background: #fff;
      border: 3px solid #ff3333;
      border-radius: 50%;
      box-shadow: 0 2px 12px #ff333355;
      z-index: 10;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s, border 0.2s, top 0.2s, transform 0.2s;
      outline: none;
      transform: translateY(-50%);
    }
    .slider-container:hover .slider-handle {
      box-shadow: 0 4px 24px #ff333388, 0 0 0 4px #ffeaea;
      transform: translateY(-50%) scale(1.08);
      cursor: grab;
    }
    .slider-handle.grabbing, .slider-handle.active {
      cursor: grabbing !important;
      box-shadow: 0 6px 32px #ff3333cc, 0 0 0 6px #ffeaea;
      background: #ffeaea;
      transform: translateY(-50%) scale(1.12);
    }
    .slider-handle .grip {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: center;
      justify-content: center;
    }
    .slider-handle .grip-dot {
      width: 6px;
      height: 6px;
      background: #ff3333;
      border-radius: 50%;
      opacity: 0.9;
      margin: 0 0.5px;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .slider-handle.active .grip-dot {
      background: #fff;
      box-shadow: 0 0 8px #ff3333, 0 0 0 2px #ff3333;
      animation: grip-bounce 0.4s cubic-bezier(.68,-0.55,.27,1.55) alternate infinite;
    }
    @keyframes grip-bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    /* --- Slider Grip Indicator --- */
    .slider-grip-indicator {
      position: fixed;
      top: 60px;
      right: 32px;
      z-index: 100;
      background: #fff;
      color: #ff3333;
      border: 2px solid #ff3333;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px #0002;
      font-size: 1.5rem;
      cursor: grab;
      transition: background 0.2s, box-shadow 0.2s;
      opacity: 0.92;
      pointer-events: none;
      visibility: hidden;
    }
    .slider-grip-indicator.active {
      visibility: visible;
      pointer-events: auto;
      animation: grip-bounce 0.7s;
    }
    @keyframes grip-bounce {
      0% { transform: scale(0.7); }
      60% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    /* --- Print: Force Landscape --- */
    @media print {
      @page { size: landscape; }
      body { background: #fff !important; color: #000 !important; }
      .controls, .slider-grip-indicator { display: none !important; }
      .sticky-header-print { display: block !important; position: static !important; background: #f5f7fa !important; color: #222 !important; border-bottom: 1.5px solid #ccc !important; box-shadow: none !important; width: 100vw !important; margin-bottom: 0 !important; padding: 12px 24px !important; font-size: 1.25em !important; page-break-after: avoid !important; }
      #buildInfo {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 10px 20px !important;
        background: #f9f9f9 !important;
        color: #222 !important;
        border-bottom: 1px solid #ccc !important;
        margin-bottom: 18px !important;
        page-break-after: avoid !important;
        font-size: 1.08em !important;
        box-shadow: none !important;
        padding: 12px 24px !important;
        line-height: 1.25 !important;
      }
      body, h1, h2, h3, h4, h5, h6, th, td, .label, .summary-table, .viewport-content, .image-box, .controls, .dashboard, #buildInfo {
        line-height: 1.25 !important;
      }
      #buildInfo-pdf { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 10px 20px !important; background: #f9f9f9 !important; color: #222 !important; border-bottom: 1px solid #ccc !important; margin-bottom: 18px !important; page-break-after: avoid; font-size: 1.08em !important; box-shadow: none !important; padding: 12px 24px !important; line-height: 1.2 !important; }
      .viewport-content { page-break-inside: avoid; }
      .slider-grip-indicator { display: none !important; }
      .slider-bar { display: none !important; }
      .pdf-viewport-heading {
        font-size: 1.5em;
        font-weight: bold;
        margin: 32px 0 12px 0;
        color: #333;
        page-break-before: auto;
      }
      .pdf-header-print { display: block !important; }
      .pdf-footer-print {
        display: block !important;
        position: static !important;
        width: 100vw !important;
        font-size: 1em !important;
        margin: 64px 0 24px 0 !important;
        text-align: center !important;
      }
      footer, .pdf-header-print, .pdf-footer-print { page-break-inside: avoid; }
      footer { display: none !important; }
      .sticky-header {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        position: static !important;
        top: 0 !important;
        width: 100vw !important;
        page-break-after: avoid !important;
        box-shadow: none !important;
        background: #f5f7fa !important;
        color: #222 !important;
      }
      .sticky-header:not(:first-of-type) {
        display: none !important;
      }
    }
    @media screen {
      .pdf-header-print, .pdf-footer-print { display: none !important; }
    }
    /* --- UI/UX Improvements --- */
    button, select {
      box-shadow: 0 1px 6px #0001;
      transition: background 0.2s, box-shadow 0.2s, border 0.2s;
      border-radius: 6px;
      border: 1.5px solid var(--border-color);
      background: var(--bg-color);
      color: var(--text-color);
      font-weight: 500;
    }
    button:hover, select:hover {
      background: var(--hover-color);
      box-shadow: 0 4px 16px #0002;
      border-color: var(--accent-color);
    }
    button[title], select[title] {
      position: relative;
    }
    button[title]:hover:after, select[title]:hover:after {
      content: attr(title);
      position: absolute;
      left: 50%;
      top: 110%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
    }
    /* --- Loading Spinner Overlay --- */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
      opacity: 0;
      pointer-events: none;
    }
    #loadingOverlay.active {
      opacity: 1;
      pointer-events: all;
    }
    .spinner {
      border: 6px solid #eee;
      border-top: 6px solid #ff3333;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* --- Animated Transitions --- */
    .fade-slide {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.4s, transform 0.4s;
      will-change: opacity, transform;
    }
    .fade-slide.active {
      opacity: 1;
      transform: translateY(0);
    }
    .slider-bar {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 6px;
      background: rgba(255,51,51,0.7);
      z-index: 5;
      left: 95%;
      border-radius: 3px;
      pointer-events: none;
    }
    /* --- Settings Popup --- */
    .settings-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.25);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .settings-modal.active {
      visibility: visible;
      opacity: 1;
    }
    .settings-modal-content {
      background: var(--panel-color);
      border-radius: 12px;
      box-shadow: 0 8px 32px #0002;
      padding: 32px 36px 24px 36px;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border: 1.5px solid var(--border-color);
      position: relative;
    }
    .settings-modal-content label {
      margin-right: 10px;
      font-weight: 500;
    }
    .settings-modal-content input[type="color"] {
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      margin-right: 8px;
      background: none;
      cursor: pointer;
    }
    .settings-modal-content input[type="number"] {
      width: 60px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }
    .settings-modal-close {
      position: absolute;
      top: 10px;
      right: 16px;
      font-size: 1.5em;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
    }
    .settings-icon-btn {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      color: var(--text-color);
      font-size: 1.2em;
      margin-right: 8px;
      padding: 4px 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
    }
    .settings-icon-btn:hover, .settings-icon-btn:focus {
      background: var(--hover-color) !important;
      box-shadow: 0 2px 8px #0001 !important;
      outline: none;
    }
    .darkmode-icon-btn {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      color: var(--text-color);
      font-size: 1.2em;
      padding: 4px 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
    }
    .darkmode-icon-btn:hover, .darkmode-icon-btn:focus {
      background: var(--hover-color) !important;
      box-shadow: 0 2px 8px #0001 !important;
      outline: none;
    }
    .reset-icon-btn {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      color: var(--text-color);
      font-size: 1.2em;
      padding: 4px 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
    }
    .reset-icon-btn:hover, .reset-icon-btn:focus {
      background: var(--hover-color) !important;
      box-shadow: 0 2px 8px #0001 !important;
      outline: none;
    }
    /* Performance: .hidden class for table rows */
    #summaryTable tbody tr.hidden { display: none !important; }
    #welcomeSection {
      max-width: 640px;
      margin: 40px auto 0 auto;
      padding: 36px 36px 28px 36px;
      border-radius: 18px;
      box-shadow: 0 6px 32px #0002;
      background: linear-gradient(120deg,#f8fbff 60%,#eaf3ff 100%);
      color: #222;
      text-align: center;
      display: block;
      font-family: var(--main-font);
      letter-spacing: 0.01em;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode #welcomeSection {
      background: linear-gradient(120deg,#23272e 60%,#23272e 100%);
      color: #f5f5f5;
      box-shadow: 0 6px 32px #0008;
    }
  </style>
</head>

<body>
  <main id="mainContent" style="flex:1 0 auto;display:flex;flex-direction:column;">
    <div class="sticky-header">
      <div style="display: flex; align-items: center; gap: 8px;">
        <img src="favicon.ico" alt="Logo" width="20" height="20" />
        <h1>LambdaTest SmartUI Reporter</h1>
      </div>
      <div>
        <button id="toggleDarkModeBtn" onclick="toggleDarkMode()" title="Toggle dark/light mode" class="darkmode-icon-btn">ðŸŒ™</button>
        <label>Upload JSON:
          <input type="file" id="jsonUpload" accept="application/json" />
        </label>
      </div>
    </div>

    <section id="welcomeSection" style="max-width:640px;margin:40px auto 0 auto;padding:36px 36px 28px 36px;border-radius:18px;box-shadow:0 6px 32px #0002;background:linear-gradient(120deg,#f8fbff 60%,#eaf3ff 100%);color:#222;text-align:center;display:block;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;letter-spacing:0.01em;">
      <h2 style="margin-top:0;margin-bottom:18px;color:#007bff;font-size:2em;font-weight:700;letter-spacing:0.01em;">Your visual test report is generated dynamically!</h2>
      <ol style="text-align:left;margin:24px 0 24px 0;padding-left:28px;font-size:1.13em;line-height:1.7;">
        <li style="margin-bottom:14px;">Run your SmartUI test command in your terminal:<br>
          <code style="display:block;background:#f5f7fa;padding:10px 14px;border-radius:8px;margin:10px 0 0 0;font-size:1.04em;color:#d6336c;font-family:'Fira Mono', 'Consolas', 'Menlo', monospace;box-shadow:0 2px 8px #0001;">smartui capture urls.json --config smartui-web.json --fetch-results results.json</code>
        </li>
        <li style="margin-bottom:14px;">Open <b style="color:#007bff;">LTSmartUIReporter.html</b> in your favorite browser.</li>
        <li style="margin-bottom:14px;">Click <b style="color:#007bff;">Upload JSON</b> and select the SmartUI JSON response <b style="color:#d6336c;">results.json</b>.</li>
      </ol>
      <div style="margin-top:22px;color:#888;font-size:1.04em;">This message will disappear once you upload your results.</div>
    </section>

    <div id="loadingOverlay">
      <div class="spinner"></div>
    </div>

    <div id="buildInfo" class="controls"></div>

    <div id="dashboardSection">
      <div class="controls">
        <label>Page:
          <select id="dashboardPageSelect"></select>
        </label>
        <label>Browser:
          <select id="dashboardBrowserSelect"></select>
        </label>
        <label>Resolution:
          <select id="dashboardViewportSelect"></select>
        </label>
        <button id="resetFiltersBtn" title="Reset filters" class="reset-icon-btn" aria-label="Reset filters" style="margin-left:8px;vertical-align:middle;display:inline-flex;align-items:center;justify-content:center;">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block;">
            <path d="M10 3a7 7 0 1 1-6.32 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4 3v4h4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      
      <button id="exportCsvBtn" disabled style="float: right; margin-left: 16px; padding: 7px 18px; border-radius: 7px; border: 1.5px solid var(--border-color); background: var(--panel-color); color: var(--text-color); font-weight: 500; font-size: 1em; cursor: pointer; box-shadow: 0 2px 8px #0001; opacity:0.6;">ðŸ’¾ Export CSV</button>
    </div>
      <table class="summary-table" id="summaryTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Page Name</th>
            <th onclick="sortTable(1)">Browser</th>
            <th onclick="sortTable(2)">Resolution</th>
            <th onclick="sortTable(3)">Mismatch %</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="detailSection" class="hidden">
      <div class="controls" style="overflow: auto;">
        <button onclick="showDashboard()" title="Back to dashboard">&larr; Dashboard</button>
        <label>Page:
          <select id="pageSelect"></select>
        </label>
        <label>Browser:
          <select id="browserSelect"></select>
        </label>
        <label>Resolution:
          <select id="viewportSelect"></select>
        </label>
        <label>Image Difference:
          <select id="imageDiff">
            <option value="baseline_diff">Baseline Diff</option>
            <option value="captured_diff">Captured Diff</option>
          </select>
        </label>
        <button onclick="exportAllPDF()" title="Export all images to PDF (landscape)" style="float: right; margin-left: 16px; padding: 7px 18px; border-radius: 7px; border: 1.5px solid var(--border-color); background: var(--panel-color); color: var(--text-color); font-weight: 500; font-size: 1em; cursor: pointer; box-shadow: 0 2px 8px #0001;">ðŸ§¾ PDF Export All Views</button>
      </div>
      <div id="viewportContentContainer"></div>
    </div>

    <div id="thumbPopup" style="display:none;position:fixed;z-index:3000;pointer-events:none;"></div>
  </main>

  <footer>
    <span class="footer-left">LambdaTest SmartUI Report Viewer - v1.1.1</span>
    <span class="footer-right">Creator. Builder. Curious? Let's talk â†’<a href="https://www.linkedin.com/in/vijopv83" target="_blank" rel="noopener noreferrer">linkedin.com/in/vijopv83</a>
    </span>
  </footer>
  
  <script defer>
    // Prevent error if renderDashboardCards is not defined
    if (typeof window.renderDashboardCards !== 'function') {
      window.renderDashboardCards = function(){};
    }

    const smartUIData = { value: null };
    let currentPage = null;
    let currentBrowser = null;
    let currentViewport = null;

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    function showDashboard() {
      const dash = document.getElementById('dashboardSection');
      const detail = document.getElementById('detailSection');
      dash.classList.add('fade-slide');
      detail.classList.add('fade-slide');
      dash.classList.add('active');
      detail.classList.remove('active');
      setTimeout(() => {
        dash.classList.remove('hidden');
        detail.classList.add('hidden');
      }, 400);
      document.title = `LambdaTest SmartUI Report`;
    }

    function showDetail(page, browser, viewport) {
      currentPage = page;
      currentBrowser = browser;
      currentViewport = viewport;
      document.title = `SmartUI ${page}`;
      populateDropdowns();
      const dash = document.getElementById('dashboardSection');
      const detail = document.getElementById('detailSection');
      dash.classList.add('fade-slide');
      detail.classList.add('fade-slide');
      dash.classList.remove('active');
      detail.classList.add('active');
      setTimeout(() => {
        dash.classList.add('hidden');
        detail.classList.remove('hidden');
      }, 400);
      renderImages(page, browser, viewport);
    }

    function populateDropdowns() {
      const pageSelect = document.getElementById('pageSelect');
      const browserSelect = document.getElementById('browserSelect');
      const viewportSelect = document.getElementById('viewportSelect');

      // Only update if changed
      const pages = Object.keys(smartUIData.value.screenshots);
      if (pageSelect.options.length !== pages.length) {
        pageSelect.innerHTML = '';
        pages.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = p;
          if (p === currentPage) opt.selected = true;
          pageSelect.appendChild(opt);
        });
      }

      const browsers = [...new Set(smartUIData.value.screenshots[currentPage].map(e => e.browser_name))];
      if (browserSelect.options.length !== browsers.length) {
        browserSelect.innerHTML = '';
        browsers.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b;
          opt.textContent = b;
          if (b === currentBrowser) opt.selected = true;
          browserSelect.appendChild(opt);
        });
      }

      const viewports = [...new Set(smartUIData.value.screenshots[currentPage].filter(e => e.browser_name === currentBrowser).map(e => e.viewport))].sort((a, b) => a - b);
      if (viewportSelect.options.length !== viewports.length) {
        viewportSelect.innerHTML = '';
        viewports.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = `${v}px`;
          if (v == currentViewport) opt.selected = true;
          viewportSelect.appendChild(opt);
        });
      }
    }

    // Event delegation for dropdowns
    document.addEventListener('change', (e) => {
      if (e.target && (e.target.id === 'pageSelect' || e.target.id === 'browserSelect' || e.target.id === 'viewportSelect' || e.target.id === 'imageDiff')) {
        currentPage = document.getElementById('pageSelect').value;
        currentBrowser = document.getElementById('browserSelect').value;
        currentViewport = document.getElementById('viewportSelect').value;
        document.title = `SmartUI ${currentPage}`;
        renderImages(currentPage, currentBrowser, currentViewport);
      }
    }, { passive: true });

    function renderImages(page, browser, viewport) {
      const container = document.getElementById('viewportContentContainer');
      const imageKey = document.getElementById('imageDiff').value;
      // Use DocumentFragment for batch DOM update
      const frag = document.createDocumentFragment();
      const entries = smartUIData.value.screenshots[page].filter(
        e => e.browser_name === browser && e.viewport == viewport
      );
      for (const s of entries) {
        // Prefetch images
        for (const key of ['baseline_image', 'captured_image', imageKey]) {
          const img = new Image();
          img.src = s[key];
        }
        const mismatchClass = getMismatchClass(s.mismatch_percentage);
        const resolution = `${s.viewport}px`;
        const div = document.createElement('div');
        div.className = 'viewport-content';
        div.innerHTML = `
      <div class="image-row">
        <div class="image-box">
          <span class="label">(${resolution}) Baseline</span>
          <img src="${s.baseline_image}" />
        </div>
        <div class="image-box">
          <span class="label">(${resolution}) Captured</span>
          <div class="slider-container" id="slider-${page}-${browser}-${viewport}">
            <div class="slider-bar" id="bar-${page}-${browser}-${viewport}"></div>
            <img src="${s.baseline_image}" class="baseline-image" loading="lazy" />
            <img src="${s.captured_image}" class="after-image" id="after-${page}-${browser}-${viewport}" style="clip-path: inset(0 25% 0 0);" loading="lazy" />
            <div class="slider-handle" id="handle-${page}-${browser}-${viewport}" style="left:95%;" tabindex="0" aria-label="Image comparison slider" role="slider" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
              <div class="grip">
                <div class="grip-dot"></div>
                <div class="grip-dot"></div>
                <div class="grip-dot"></div>
                <div class="grip-dot"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="image-box">
          <span class="label">(${resolution}) Diff: 
            <span class="${mismatchClass}">Mismatch: ${s.mismatch_percentage}%</span>
          </span>
          <img src="${s[imageKey]}" />
        </div>
      </div>
    `;
        frag.appendChild(div);
      }
      container.innerHTML = '';
      container.appendChild(frag);
      requestAnimationFrame(initAllSliders);
    }

    function getMismatchClass(percent) {
      if (percent < 5) return 'mismatch-low';
      if (percent < 10) return 'mismatch-mid';
      return 'mismatch-high';
    }

    function exportAllPDF() {
      const container = document.getElementById('viewportContentContainer');
      const imageKey = document.getElementById('imageDiff').value;
      container.innerHTML = '';
      // Group screenshots by browser, then by viewport in a single pass
      const screenshots = smartUIData.value.screenshots[currentPage];
      const browserMap = new Map();
      const uniqueImageUrls = new Set();
      screenshots.forEach(e => {
        if (!browserMap.has(e.browser_name)) browserMap.set(e.browser_name, new Map());
        const viewportMap = browserMap.get(e.browser_name);
        if (!viewportMap.has(e.viewport)) viewportMap.set(e.viewport, []);
        viewportMap.get(e.viewport).push(e);
        // Collect unique image URLs for prefetch
        ['baseline_image', 'captured_image', imageKey].forEach(key => {
          if (e[key]) uniqueImageUrls.add(e[key]);
        });
      });
      // Prefetch all unique images
      const imagePromises = [];
      uniqueImageUrls.forEach(url => {
        const img = new Image();
        img.src = url;
        imagePromises.push(new Promise(resolve => {
          img.onload = resolve;
          img.onerror = resolve;
        }));
      });
      Promise.all(imagePromises).then(() => {
        // Use DocumentFragment for batch DOM update
        const frag = document.createDocumentFragment();
        // --- Main content: browsers/viewport groups ---
        let browserIdx = 0;
        browserMap.forEach((viewportMap, browser) => {
          const browserGroupDiv = document.createElement('div');
          if (browserIdx > 0) browserGroupDiv.style.pageBreakBefore = 'always';
          // Add a heading for the browser
          const browserHeading = document.createElement('h2');
          browserHeading.className = 'pdf-viewport-heading';
          browserHeading.textContent = `Browser: ${browser}`;
          browserGroupDiv.appendChild(browserHeading);
          // For each viewport in this browser
          Array.from(viewportMap.keys()).sort((a, b) => a - b).forEach(viewport => {
            // Add a title for the viewport
            const viewportTitle = document.createElement('h3');
            viewportTitle.textContent = `Viewport: ${viewport}px`;
            viewportTitle.style.margin = '18px 0 8px 0';
            browserGroupDiv.appendChild(viewportTitle);
            // Render all entries for this browser/viewport
            const filtered = viewportMap.get(viewport);
            if (!filtered || filtered.length === 0) {
              const div = document.createElement('div');
              div.className = 'viewport-content';
              div.innerHTML = `<div style="color:#888;padding:24px 0 24px 0;text-align:center;">No images for this browser/viewport.</div>`;
              browserGroupDiv.appendChild(div);
            } else {
              filtered.forEach(s => {
                const mismatchClass = getMismatchClass(s.mismatch_percentage);
                const resolution = `${s.viewport}px`;
                const div = document.createElement('div');
                div.className = 'viewport-content';
                div.innerHTML = `
              <div class="image-row">
                <div class="image-box">
                  <span class="label">(${resolution}) Baseline</span>
                  <img src="${s.baseline_image}" loading="lazy" />
                </div>
                <div class="image-box">
                  <span class="label">(${resolution}) Captured</span>
                  <div class="slider-container" id="slider-${currentPage}-${browser}-${viewport}">
                    <div class="slider-bar" id="bar-${currentPage}-${browser}-${viewport}"></div>
                    <img src="${s.baseline_image}" class="baseline-image" loading="lazy" />
                    <img src="${s.captured_image}" class="after-image" id="after-${currentPage}-${browser}-${viewport}" style="clip-path: inset(0 25% 0 0);" loading="lazy" />
                    <div class="slider-handle" id="handle-${currentPage}-${browser}-${viewport}" style="left:95%; background: red;" tabindex="0" aria-label="Image comparison slider" role="slider" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                      <div class="grip">
                        <div class="grip-dot"></div>
                        <div class="grip-dot"></div>
                        <div class="grip-dot"></div>
                        <div class="grip-dot"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="image-box">
                  <span class="label">(${resolution}) Diff: 
                    <span class="${mismatchClass}">Mismatch: ${s.mismatch_percentage}%</span>
                  </span>
                  <img src="${s[imageKey]}" loading="lazy" />
                </div>
              </div>`;
                browserGroupDiv.appendChild(div);
              });
            }
          });
          frag.appendChild(browserGroupDiv);
          browserIdx++;
        });
        // Add footer to the very last page
        const pdfFooter = document.createElement('div');
        pdfFooter.className = 'pdf-footer-print';
        pdfFooter.textContent = document.querySelector('footer')?.innerText || '';
        frag.appendChild(pdfFooter);
        container.innerHTML = '';
        container.appendChild(frag);
        // Set all sliders to 100% before printing
        setAllSliders(100);
        // Wait for all images to be rendered in the DOM before printing
        const imgs = Array.from(container.querySelectorAll('img'));
        let loaded = 0;
        if (imgs.length === 0) {
          doPrint();
        } else {
          imgs.forEach(img => {
            if (img.complete) {
              loaded++;
              if (loaded === imgs.length) doPrint();
            } else {
              img.onload = img.onerror = () => {
                loaded++;
                if (loaded === imgs.length) doPrint();
              };
            }
          });
        }
        function doPrint() {
          setTimeout(() => {
            window.print();
            // Restore all sliders to 75% after printing
            setTimeout(() => setAllSliders(75), 100);
            renderImages(currentPage, currentBrowser, currentViewport);
          }, 100);
        }
      });
    }

    function populateDashboardFilters(pages, browsers, viewports) {
      const pageSelect = document.getElementById('dashboardPageSelect');
      const browserSelect = document.getElementById('dashboardBrowserSelect');
      const viewportSelect = document.getElementById('dashboardViewportSelect');
      const createOption = (value) => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        return opt;
      };
      // Use DocumentFragment for batch DOM update
      const pageFrag = document.createDocumentFragment();
      const browserFrag = document.createDocumentFragment();
      const viewportFrag = document.createDocumentFragment();
      pageFrag.appendChild(createOption('All'));
      browserFrag.appendChild(createOption('All'));
      viewportFrag.appendChild(createOption('All'));
      pages.forEach(p => pageFrag.appendChild(createOption(p)));
      browsers.forEach(b => browserFrag.appendChild(createOption(b)));
      Array.from(viewports).sort((a, b) => a - b).forEach(v => viewportFrag.appendChild(createOption(v)));
      pageSelect.innerHTML = '';
      browserSelect.innerHTML = '';
      viewportSelect.innerHTML = '';
      pageSelect.appendChild(pageFrag);
      browserSelect.appendChild(browserFrag);
      viewportSelect.appendChild(viewportFrag);
    }

    // Debounce filter calls for performance
    let filterTimeout = null;
    ["dashboardPageSelect", "dashboardBrowserSelect", "dashboardViewportSelect"].forEach(id => {
      document.getElementById(id).addEventListener("change", function() {
        if (filterTimeout) clearTimeout(filterTimeout);
        filterTimeout = setTimeout(filterSummaryTable, 60);
      });
    });

    function filterSummaryTable() {
      const selectedPage = document.getElementById('dashboardPageSelect').value;
      const selectedBrowser = document.getElementById('dashboardBrowserSelect').value;
      const selectedViewport = document.getElementById('dashboardViewportSelect').value;
      const rows = document.querySelectorAll('#summaryTable tbody tr');
      rows.forEach(row => {
        const page = row.dataset.page;
        const browser = row.dataset.browser;
        const viewport = row.dataset.viewport;
        const matchPage = selectedPage === 'All' || selectedPage === page;
        const matchBrowser = selectedBrowser === 'All' || selectedBrowser === browser;
        const matchViewport = selectedViewport === 'All' || selectedViewport === viewport;
        if (matchPage && matchBrowser && matchViewport) {
          row.classList.remove('hidden');
        } else {
          row.classList.add('hidden');
        }
      });
    }

    function hideWelcomeSection() {
      const section = document.getElementById('welcomeSection');
      if (section) section.style.display = 'none';
    }
    function showWelcomeSection() {
      const section = document.getElementById('welcomeSection');
      if (section) section.style.display = 'block';
    }
    // On load, show welcome section if no data
    document.addEventListener('DOMContentLoaded', function() {
      if (!smartUIData.value) {
        showWelcomeSection();
        // Hide dashboard/tables until data is loaded
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('detailSection').style.display = 'none';
        document.getElementById('buildInfo').style.display = 'none';
      }
    });
    // On JSON upload, hide welcome section and show dashboard
    function handleJsonUpload(file) {
      if (!file) return;
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.add('active');
      file.text().then(content => {
        try {
          smartUIData.value = JSON.parse(content);
          // Enable Export CSV button
          const exportBtn = document.getElementById('exportCsvBtn');
          if (exportBtn) {
            exportBtn.disabled = false;
            exportBtn.style.opacity = '';
          }
          const { build, project } = smartUIData.value;
          const fileTime = new Date(file.lastModified).toLocaleString();
          const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          const fileMetaText = `${fileTime} (${timezone})`;
          let buildInfo = document.getElementById('buildInfo');
          if (!buildInfo) {
            const stickyHeader = document.querySelector('.sticky-header');
            buildInfo = document.createElement('div');
            buildInfo.id = 'buildInfo';
            buildInfo.className = 'controls';
            if (stickyHeader && stickyHeader.parentNode) {
              stickyHeader.parentNode.insertBefore(buildInfo, stickyHeader.nextSibling);
            } else {
              document.body.insertBefore(buildInfo, document.body.firstChild);
            }
          }
          buildInfo.innerHTML = `
            <div><strong>File Date Time:</strong> ${fileMetaText}</div>
            <div><strong>Build:</strong> ${build.build_name}</div>
            <div><strong>Build ID:</strong> ${build.build_id}</div>
            <div><strong>Status:</strong> ${build.build_status}</div>
            <div><strong>Comparison:</strong> ${build.comparisonStrategy}</div>
            <div><strong>Branch:</strong> ${build.branch}</div>
            <div><strong>Platform:</strong> ${project.platform}</div>
            <div><strong>Project:</strong> ${project.name}</div>
            <div><strong>Category:</strong> ${project.projectCategory}</div>
            <div><strong>User:</strong> ${project.username}</div>
            <div><strong>Baseline:</strong> ${build.baseline}</div>
            <div><strong>Pages:</strong> ${Object.keys(smartUIData.value.screenshots).length}</div>
          `;
          renderSummaryTable(true);
          renderDashboardCards();
          showDashboard();
          hideWelcomeSection();
          // Always show dashboard, detail, and build info after upload
          document.getElementById('dashboardSection').style.display = '';
          document.getElementById('detailSection').style.display = '';
          document.getElementById('buildInfo').style.display = '';
          setTimeout(() => overlay.classList.remove('active'), 400);
        } catch (err) {
          alert("Invalid JSON: " + err.message);
          overlay.classList.remove('active');
        }
      });
    }
    document.getElementById('jsonUpload').addEventListener('change', function (event) {
      handleJsonUpload(event.target.files[0]);
    });

    function renderSummaryTable(defaultSort = true) {
      applyMismatchColors(); // Always apply latest colors
      const tbody = document.querySelector('#summaryTable tbody');
      // Use DocumentFragment for batch DOM update
      const frag = document.createDocumentFragment();
      const screenshots = smartUIData.value.screenshots;

      const pageSet = new Set();
      const browserSet = new Set();
      const viewportSet = new Set();

      let rows = [];
      for (const page of Object.keys(screenshots)) {
        for (const entry of screenshots[page]) {
          pageSet.add(page);
          browserSet.add(entry.browser_name);
          viewportSet.add(entry.viewport);
          const mismatchClass = getMismatchClass(entry.mismatch_percentage);
          const row = document.createElement('tr');
          row.dataset.page = page;
          row.dataset.browser = entry.browser_name;
          row.dataset.viewport = entry.viewport;
          // Use baseline_diff for popup on page name
          const baselineDiff = entry.baseline_diff || entry.captured_diff || entry.baseline_image || '';
          row.innerHTML = `
            <td><a href="#" data-detail="${page}|${entry.browser_name}|${entry.viewport}" data-thumb="${baselineDiff}" class="summary-page-link">${page}</a></td>
            <td>${entry.browser_name}</td>
            <td>${entry.viewport}px</td>
            <td class="${mismatchClass}">${entry.mismatch_percentage}%</td>
            <td>${entry.status || ''}</td>
          `;
          // Store for sorting
          rows.push({ row, mismatch: parseFloat(entry.mismatch_percentage) });
        }
      }
      // Default sort by Mismatch % Descending
      if (defaultSort) {
        rows.sort((a, b) => b.mismatch - a.mismatch);
      }
      rows.forEach(({ row }) => frag.appendChild(row));
      tbody.innerHTML = '';
      tbody.appendChild(frag);
      populateDashboardFilters(Array.from(pageSet), Array.from(browserSet), Array.from(viewportSet));
    }

    function sortTable(colIndex) {
      const table = document.getElementById("summaryTable");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.rows);
      const dir = table.getAttribute(`data-sort-dir-${colIndex}`) === 'asc' ? 'desc' : 'asc';
      const isNumeric = colIndex === 2 || colIndex === 3;

      rows.sort((a, b) => {
        const x = a.cells[colIndex].innerText.replace('%', '').replace('px', '');
        const y = b.cells[colIndex].innerText.replace('%', '').replace('px', '');
        return (isNumeric ? parseFloat(x) - parseFloat(y) : x.localeCompare(y)) * (dir === 'asc' ? 1 : -1);
      });

      table.setAttribute(`data-sort-dir-${colIndex}`, dir);
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
    }

    // --- Slider Grip Indicator & IntersectionObserver Lazy Loading ---
    function initAllSliders() {
      const grip = document.getElementById('sliderGripIndicator');
      let activeSlider = null;
      let dragging = false;
      let lastX = null;
      let lastY = null;

      // IntersectionObserver for images (performance: only observe new images)
      if ('IntersectionObserver' in window) {
        const lazyImgs = document.querySelectorAll('img[loading="lazy"]');
        lazyImgs.forEach(img => {
          if (img.dataset.src) return;
          const src = img.src;
          img.removeAttribute('src');
          img.dataset.src = src;
        });
        const io = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                delete img.dataset.src;
              }
              observer.unobserve(img);
            }
          });
        }, { rootMargin: '200px' });
        lazyImgs.forEach(img => io.observe(img));
      }

      document.querySelectorAll('.slider-container').forEach((slider) => {
        const after = slider.querySelector('.after-image');
        const handle = slider.querySelector('.slider-handle');
        function setSlider(percent, y = null) {
          handle.style.left = percent + '%';
          after.style.clipPath = `inset(0 ${100 - percent}% 0 0)`;
          handle.setAttribute('aria-valuenow', percent.toFixed(0));
          const bar = slider.querySelector('.slider-bar');
          if (bar) bar.style.left = percent + '%';
          // Float handle vertically with mouse/touch if dragging
          if (dragging && y !== null) {
            const sliderRect = slider.getBoundingClientRect();
            let relY = y - (sliderRect.top + window.scrollY);
            // Clamp to slider bounds (handle height is 32px)
            relY = Math.max(16, Math.min(relY, slider.offsetHeight - 16));
            handle.style.top = relY + 'px';
          } else if (slider.classList.contains('hovering') && y !== null) {
            // Float handle with mouse when hovering (not dragging)
            const sliderRect = slider.getBoundingClientRect();
            let relY = y - (sliderRect.top + window.scrollY);
            relY = Math.max(16, Math.min(relY, slider.offsetHeight - 16));
            handle.style.top = relY + 'px';
          } else {
            handle.style.top = '50%';
          }
        }
        setSlider(75);

        // Mouse move float effect when hovering
        slider.addEventListener('mousemove', e => {
          if (!dragging) {
            slider.classList.add('hovering');
            setSlider(parseFloat(handle.style.left), e.pageY);
          }
        });
        slider.addEventListener('mouseleave', () => {
          slider.classList.remove('hovering');
          if (!dragging) setSlider(parseFloat(handle.style.left), null);
        });

        function updateSlider(x, y) {
          // Use pageX and slider.offsetLeft for robust drag even when scrolling
          const sliderLeft = slider.getBoundingClientRect().left + window.scrollX;
          const sliderWidth = slider.offsetWidth;
          let offset = x - sliderLeft;
          offset = Math.max(0, Math.min(offset, sliderWidth));
          const percent = (offset / sliderWidth) * 100;
          setSlider(percent, y);
        }

        function onMove(e) {
          if (!dragging) return;
          let x, y;
          if (e.touches) {
            x = e.touches[0].pageX;
            y = e.touches[0].pageY;
          } else {
            x = e.pageX;
            y = e.pageY;
          }
          lastX = x;
          lastY = y;
        }

        function rafUpdate() {
          if (dragging && lastX !== null && lastY !== null) {
            updateSlider(lastX, lastY);
            lastX = null;
            lastY = null;
          }
          if (dragging) {
            requestAnimationFrame(rafUpdate);
          }
        }

        handle.addEventListener('mousedown', e => {
          dragging = true;
          lastX = e.pageX;
          lastY = e.pageY;
          activeSlider = slider;
          showGrip(true);
          handle.classList.add('active');
          handle.classList.add('grabbing');
          updateSlider(e.pageX, e.pageY);
          requestAnimationFrame(rafUpdate);
          e.preventDefault();
        });
        // Use passive listeners for performance
        window.addEventListener('mousemove', onMove, { passive: true });
        window.addEventListener('mouseup', () => { dragging = false; showGrip(false); handle.classList.remove('active'); setSlider(parseFloat(handle.style.left), null); handle.classList.remove('grabbing'); }, { passive: true });

        // Touch support
        handle.addEventListener('touchstart', e => {
          dragging = true;
          lastX = e.touches[0].pageX;
          lastY = e.touches[0].pageY;
          activeSlider = slider;
          showGrip(true);
          handle.classList.add('active');
          handle.classList.add('grabbing');
          updateSlider(e.touches[0].pageX, e.touches[0].pageY);
          requestAnimationFrame(rafUpdate);
          e.preventDefault();
        }, { passive: true });
        window.addEventListener('touchmove', onMove, { passive: true });
        window.addEventListener('touchend', () => { dragging = false; showGrip(false); handle.classList.remove('active'); setSlider(parseFloat(handle.style.left), null); handle.classList.remove('grabbing'); }, { passive: true });

        // Click to move
        slider.addEventListener('click', e => {
          if (e.target === handle) return;
          updateSlider(e.pageX, e.pageY);
        });

        // Keyboard accessibility
        handle.addEventListener('keydown', e => {
          let percent = parseFloat(handle.style.left) || 75;
          if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
            percent = Math.max(0, percent - 5);
            setSlider(percent);
            e.preventDefault();
          } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
            percent = Math.min(100, percent + 5);
            setSlider(percent);
            e.preventDefault();
          }
        });

        // Show grip when slider is in view
        slider.addEventListener('mouseenter', () => { activeSlider = slider; showGrip(true); });
        slider.addEventListener('mouseleave', () => { if (!dragging) showGrip(false); });
      });

      function showGrip(show) {
        const grip = document.getElementById('sliderGripIndicator');
        if (!grip) return;
        if (show) {
          grip.classList.add('active');
        } else {
          grip.classList.remove('active');
        }
      }
    }

    // --- PDF Export: set slider to 100% then restore to 75% ---
    function setAllSliders(percent) {
      document.querySelectorAll('.slider-container').forEach((slider) => {
        const after = slider.querySelector('.after-image');
        const handle = slider.querySelector('.slider-handle');
        handle.style.left = percent + '%';
        after.style.clipPath = `inset(0 ${100 - percent}% 0 0)`;
      });
    }

    // Apply custom colors to mismatch classes
    function applyMismatchColors() {
      const style = document.getElementById('mismatchColorStyle') || document.createElement('style');
      style.id = 'mismatchColorStyle';
      style.innerHTML = `
        .mismatch-low { color: #008000 !important; }
        .mismatch-mid { color: #ffa500 !important; }
        .mismatch-high { color: #ff3333 !important; }
      `;
      document.head.appendChild(style);
    }

    // Update dark mode button icon based on mode
    function updateDarkModeIcon() {
      const btn = document.getElementById('toggleDarkModeBtn');
      if (!btn) return;
      if (document.body.classList.contains('dark-mode')) {
        btn.textContent = 'â˜€ï¸';
        btn.title = 'Switch to light mode';
      } else {
        btn.textContent = 'ðŸŒ™';
        btn.title = 'Switch to dark mode';
      }
      // Also update welcomeSection colors
      const welcome = document.getElementById('welcomeSection');
      if (welcome) {
        if (document.body.classList.contains('dark-mode')) {
          welcome.style.background = 'linear-gradient(120deg,#23272e 60%,#23272e 100%)';
          welcome.style.color = '#f5f5f5';
          welcome.style.boxShadow = '0 6px 32px #0008';
        } else {
          welcome.style.background = 'linear-gradient(120deg,#f8fbff 60%,#eaf3ff 100%)';
          welcome.style.color = '#222';
          welcome.style.boxShadow = '0 6px 32px #0002';
        }
      }
    }
    // Patch toggleDarkMode to update icon
    const origToggleDarkMode = window.toggleDarkMode;
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      updateDarkModeIcon();
    };
    // On load, set correct icon
    document.addEventListener('DOMContentLoaded', updateDarkModeIcon);

    // Ensure buildInfo always exists after sticky-header
    document.addEventListener('DOMContentLoaded', function() {
      let buildInfo = document.getElementById('buildInfo');
      if (!buildInfo) {
        const stickyHeader = document.querySelector('.sticky-header');
        buildInfo = document.createElement('div');
        buildInfo.id = 'buildInfo';
        buildInfo.className = 'controls';
        if (stickyHeader && stickyHeader.parentNode) {
          stickyHeader.parentNode.insertBefore(buildInfo, stickyHeader.nextSibling);
        } else {
          document.body.insertBefore(buildInfo, document.body.firstChild);
        }
      }
    });

    // Event delegation for summary table row clicks
    document.getElementById('summaryTable').addEventListener('click', function(e) {
      const link = e.target.closest('a[data-detail]');
      if (link) {
        const [page, browser, viewport] = link.getAttribute('data-detail').split('|');
        showDetail(page, browser, viewport);
        e.preventDefault();
      }
    });

    // Export CSV logic
    document.getElementById('exportCsvBtn').addEventListener('click', function() {
      // Only export visible rows, and include all columns (Page Name, Browser, Resolution, Mismatch %, Status)
      const rows = Array.from(document.querySelectorAll('#summaryTable tbody tr'));
      const visibleRows = rows.filter(row => row.style.display !== 'none');
      const headers = Array.from(document.querySelectorAll('#summaryTable thead th')).map(th => th.textContent.trim());
      const csv = [headers.join(',')];
      for (const row of visibleRows) {
        const cells = Array.from(row.children).map(td => '"' + td.textContent.trim().replace(/"/g, '""') + '"');
        csv.push(cells.join(','));
      }
      let buildName = 'SmartUI-Reporter';
      try {
        if (smartUIData.value && smartUIData.value.build && smartUIData.value.build.build_name) {
          buildName = 'SmartUI Reporter ' + smartUIData.value.build.build_name;
        }
      } catch (e) {}
      const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = buildName + '.csv';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    });

    // Add a simple spinner for the popup
    const thumbPopupSpinner = document.createElement('div');
    thumbPopupSpinner.className = 'spinner';
    thumbPopupSpinner.style.width = '36px';
    thumbPopupSpinner.style.height = '36px';
    thumbPopupSpinner.style.margin = '32px auto';

    (function() {
      const popup = document.getElementById('thumbPopup');
      let popupImg = null;
      document.addEventListener('mouseover', function(e) {
        const link = e.target.closest('.summary-page-link');
        if (link) {
          if (!popupImg) {
            popupImg = document.createElement('img');
            popupImg.style.display = 'block';
            popupImg.style.maxWidth = '80vw';
            popupImg.style.width = 'auto';
            popupImg.style.height = 'auto';
            popupImg.style.maxHeight = '80vh';
            popupImg.style.aspectRatio = 'auto';
            popupImg.style.borderRadius = '8px';
            popupImg.style.boxShadow = '0 4px 24px #0005';
            popupImg.style.margin = '0 auto';
          }
          popup.innerHTML = '';
          popup.appendChild(thumbPopupSpinner);
          popup.style.display = 'block';
          popupImg.onload = function() {
            if (popup.contains(thumbPopupSpinner)) popup.removeChild(thumbPopupSpinner);
            popup.appendChild(popupImg);
          };
          popupImg.onerror = function() {
            if (popup.contains(thumbPopupSpinner)) popup.removeChild(thumbPopupSpinner);
            popup.innerHTML = '<div style="color:red;padding:16px;">Failed to load image</div>';
          };
          popupImg.src = link.getAttribute('data-thumb');
        }
      });
      document.addEventListener('mousemove', function(e) {
        if (popup.style.display === 'block' && (popupImg || popup.contains(thumbPopupSpinner))) {
          const pad = 24;
          let width = window.innerWidth * 0.8;
          let height = popupImg && popupImg.naturalHeight && popupImg.naturalWidth ? Math.min(window.innerHeight * 0.8, width * (popupImg.naturalHeight / popupImg.naturalWidth)) : 220;
          let left = e.clientX + pad;
          let top = e.clientY - 20;
          if (left + width > window.innerWidth) left = window.innerWidth - width - pad;
          if (top + height > window.innerHeight) top = window.innerHeight - height - pad;
          if (top < 0) top = pad;
          popup.style.left = left + 'px';
          popup.style.top = top + 'px';
        }
      });
      document.addEventListener('mouseout', function(e) {
        if (e.target.classList && e.target.classList.contains('summary-page-link')) {
          popup.style.display = 'none';
        }
      });
    })();

    // Reset filters button logic
    document.addEventListener('DOMContentLoaded', function() {
      const resetBtn = document.getElementById('resetFiltersBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          const pageSelect = document.getElementById('dashboardPageSelect');
          const browserSelect = document.getElementById('dashboardBrowserSelect');
          const viewportSelect = document.getElementById('dashboardViewportSelect');
          if (pageSelect) pageSelect.value = 'All';
          if (browserSelect) browserSelect.value = 'All';
          if (viewportSelect) viewportSelect.value = 'All';
          if (typeof filterSummaryTable === 'function') filterSummaryTable();
        });
      }
    });
  </script>
</body>

</html>
